<?xml version="1.0" encoding="UTF-8"?>
<config xmlns="http://web-harvest.sourceforge.net/schema/1.0/config" scriptlang="groovy">	
    <selenium-flow>
      <selenium name="seleniumDriver" browser="internet explorer" close-on-completion="true" start-in-private="true">
        <script><![CDATA[
        	import java.util.concurrent.ConcurrentSkipListMap.KeySet;
        	import java.util.concurrent.TimeUnit; 
			import org.openqa.selenium.support.ui.Select;
			// make list with map with item to the invoice for test
			items = [
			["item": "product 1", "quantity" : "2", "price" : "25", "discount" : "5", "description" : "some test product 1"],
			["item": "product 2", "quantity" : "1", "price" : "50", "discount" : "0", "description" : "some test product 2"]			
			]; 
        	// get web driver and set his setups
            ieDriver = seleniumDriver.getWrappedObject();
            ieDriver.manage().timeouts().implicitlyWait(2, TimeUnit.MINUTES).pageLoadTimeout(1, TimeUnit.MINUTES);
            // get invoice plane page            
            ieDriver.get("https://invoiceplane.workfusion.com");            
			element_present = ieDriver.getPageSource().contains("btn btn-block btn-primary");
			// if it need login to the invoiceplane
			if(element_present) { 
				// set login name
            	userNameTextBox = ieDriver.findElement(By.id("email"));
            	userNameTextBox.click();
            	userNameTextBox.sendKeys("wf-robot@mail.com");
             	// set login password
            	passWordTextBox =ieDriver.findElement(By.id("password"));
            	passWordTextBox.click();
            	passWordTextBox.sendKeys("freedom4ROBOTS");
             	// click login button
            	logInButton =ieDriver.findElement(By.name("btn_login"));
            	logInButton.click();
            }
			// click 'invoices' in the parent main menu
            ieDriver.findElement(By.xpath("//div/div/ul[1]/li[4]/a")).click();
            // click 'Create invoce' in the child menu
           	ieDriver.findElement(By.linkText("Create Invoice")).click();
			// select 'Client' by text value from list
    		selectClient = new Select(ieDriver.findElement(By.xpath("//select[@id='client_name']")));
        	selectClient.selectByVisibleText("SR Infotech");
			// set 'invoice' date
            elementDate = ieDriver.findElement(By.id("invoice_date_created"));
            elementDate.click();
            elementDate.clear(); //clear old date for correct entered
            elementDate.sendKeys("10/02/2017");
            elementDate.sendKeys(Keys.ENTER);
            // select 'Invoice group' by text value from list
      		selectIG = new Select(ieDriver.findElement(By.xpath("//select[@id='invoice_group_id']")));
        	selectIG.selectByVisibleText("Invoice Default");
        	// press 'Submit' to the create invoice
        	submitButton = ieDriver.findElement(By.id("invoice_create_confirm"));
            submitButton.click();
            // filling items tabl in the invoice
            apacheSU = org.apache.commons.lang3.StringUtils;
            //----------
            def addItems	= 0;
            def itemsSize	= items.size();
            //----------
            items.each {
            	// calc add item
            	addItems++;
            	// get item row values
				item		= apacheSU.isBlank(it.get("item")) 			? "N/A" 			: it.get("item");
				quantity	= apacheSU.isBlank(it.get("quantity")) 		? "0"				: it.get("quantity");
				price		= apacheSU.isBlank(it.get("price")) 		? "0"				: it.get("price");
				discount	= apacheSU.isBlank(it.get("discount")) 		? "0"				: it.get("discount");
				description	= apacheSU.isBlank(it.get("description"))	? "No description"	: it.get("description"); 
				// set item row value in invoice
            	ieDriver.findElement(By.xpath("//*[@id='item_table']/tbody[last()]/tr[1]//input[@name='item_name']")).sendKeys(item);
            	ieDriver.findElement(By.xpath("//*[@id='item_table']/tbody[last()]/tr[1]//input[@name='item_quantity']")).sendKeys(quantity);
            	ieDriver.findElement(By.xpath("//*[@id='item_table']/tbody[last()]/tr[1]//input[@name='item_price']")).sendKeys(price);
            	ieDriver.findElement(By.xpath("//*[@id='item_table']/tbody[last()]/tr[1]//input[@name='item_discount_amount']")).sendKeys(discount);
            	ieDriver.findElement(By.xpath("//*[@id='item_table']/tbody[last()]/tr[2]/td[1]/div/textarea[@name='item_description']")).sendKeys(description);
				// if not all item in invoice add new item row
				if(addItems<itemsSize) {
					ieDriver.findElement(By.cssSelector(".btn_add_row")).click();
				}
			}
			// set discount for full invoice items
			ieDriver.findElement(By.xpath("//input[@id='invoice_discount_percent']")).sendKeys("5");
			// set 'Invoice Terms'
			ieDriver.findElement(By.xpath("//textarea[@id='invoice_terms']")).sendKeys("Some invoice terms");
			// set 'Invoice Process'
			ieDriver.findElement(By.xpath("//input[@id='invoice_custom_invoice_process']")).sendKeys("Some invoice process");
			// wait 5 seconds for view
			TimeUnit.SECONDS.sleep(5);
			// save 'invoice'
            ieDriver.findElement(By.id("btn_save_invoice")).click();
            // save link for created invoice for export to output data
            binding.putAt("invoice_url", ieDriver.getCurrentUrl().toString());
            
  			// wait 5 seconds for view
			TimeUnit.SECONDS.sleep(5);
        ]]></script>
      </selenium>
    </selenium-flow>
    <export include-original-data="true">
    	<single-column name="invoice_url" value="${invoice_url}"/>
    </export>
</config>