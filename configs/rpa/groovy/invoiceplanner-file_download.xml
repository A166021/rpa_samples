<?xml version="1.0" encoding="UTF-8"?>
<config xmlns="http://web-harvest.sourceforge.net/schema/1.0/config" scriptlang="groovy">

<selenium-flow>
	<!-- {{ open invoiceplane, login and creating invoice -->
    <selenium browser="internet explorer" start-in-private="true" close-on-completion="false">
        <script><![CDATA[              
			import java.util.concurrent.TimeUnit; 
             
            ieDriver = seleniumDriver.getWrappedObject();              
            ieDriver.manage().timeouts().implicitlyWait(1, TimeUnit.MINUTES).pageLoadTimeout(1, TimeUnit.MINUTES);  
            
            // get invoice plane page            
            ieDriver.get("https://invoiceplane.workfusion.com");            
			element_present = ieDriver.getPageSource().contains("btn btn-block btn-primary");
			
			// if need login to the invoiceplane
			if(element_present) { 
				// set login name
            	userNameTextBox = ieDriver.findElement(By.id("email"));
            	userNameTextBox.click();
            	userNameTextBox.sendKeys("wf-robot@mail.com");
             
             	// set login password
            	passWordTextBox =ieDriver.findElement(By.id("password"));
            	passWordTextBox.click();
            	passWordTextBox.sendKeys("freedom4ROBOTS");
             
             	// click login button
            	logInButton =ieDriver.findElement(By.name("btn_login"));
            	logInButton.click();
            }
         
         	// get invoice aging page
            ieDriver.get("https://invoiceplane.workfusion.com/reports/invoice_aging");                      
              
            // try creating invoice                  
            try {
            	ieDriver.manage().timeouts().pageLoadTimeout(10, TimeUnit.SECONDS);
                ieDriver.findElement(By.name("btn_submit")).click();
            } catch(org.openqa.selenium.TimeoutException ignored) {}              
          
			/* Switch to 'Save' dialog by ALT+n */ 
            ieDriver.getKeyboard().sendKeys(Keys.chord(Keys.LEFT_ALT, "n"));
			
            /* By TAB > ARROW_DOWN > ARROW_DOWN > ENTER pull up 'Save As' and click context menu item */
			ieDriver.getKeyboard().sendKeys(Keys.TAB.toString());
            ieDriver.getKeyboard().sendKeys(Keys.ARROW_DOWN.toString());
            ieDriver.getKeyboard().sendKeys(Keys.ARROW_DOWN.toString());
            ieDriver.getKeyboard().sendKeys(Keys.ENTER.toString());
         ]]></script>
    </selenium>
   	<!-- }} open invoiceplane, login and creating invoice -->
   	
   	<!-- {{ work with windows save dialog -->
    <selenium name="autoitDriverw" browser="autoit" close-on-completion="true">
         <script><![CDATA[
			import java.text.SimpleDateFormat;
			import java.util.Date;                     
			import java.util.concurrent.TimeUnit;
		
			// make formatted string date text	
            dateFormat = new SimpleDateFormat("MM_dd_yyyy_(HH_mm_ss)");                     
            date = dateFormat.format(new Date());
             
            aDriver = autoitDriverw.getWrappedObject();
            aDriver.manage().timeouts().implicitlyWait(1, TimeUnit.MINUTES);
            // change window to save dialog
            aDriver.switchTo().window("[CLASS:#32770]");
            // get pdf name wo date
            pdfname= aDriver.findElement(By.cssSelector("[CLASS:Edit;INSTANCE:1]")).getText();           
           	// creating full path to save file with date in filename 
            filename= "C:\\RPA\\" + pdfname+ "_"+ date + ".pdf" ;              
            // set full path to save dialog
            aDriver.findElement(By.cssSelector("[CLASS:Edit;INSTANCE:1]")).sendKeys(filename);       
            // click save button
            aDriver.findElement(By.cssSelector("[CLASS:Button;INSTANCE:1]")).click();     
			// execute script for get file resource
			res = aDriver.executeScript(
                        "def bytes = new File('" + filename.replace('\\', '/') + "').bytes; \n"
                            + "return Base64.getEncoder().encodeToString(bytes);", "GROOVY");
 			// convert resource to base64
            fileBytes = Base64.getDecoder().decode(res.toString());  
          ]]></script>
    </selenium>
    <!-- }} work with windows save dialog -->
</selenium-flow>

<!-- {{ save file local path to output data -->
<export include-original-data="true">
 	<single-column name="rpa_local_file_path" value="${filename}"/>
</export>

</config>